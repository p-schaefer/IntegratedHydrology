---
title: "IntegratedHydrology: Integrated hydrology tools for environmental science"
always_allow_html: true
output: 
  github_document:
    pandoc_args: --webtex
editor_options: 
  markdown: 
    wrap: 72
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

## Contents

-   [1.0 Introduction](#10-introduction)
-   [2.0 System setup and installation](#20-system-setup-and-installation)
-   [3.0 Prepare DEM and Sampling Points for for analysis](#30-inverse-distance-weighted-rasters-using-hydroweight)
-   [3.1 Generate toy terrain dataset and sampling points](#31-generate-toy-terrain-dataset)
-   [3.2 Process DEM with `process_hydrology()`](#32-generate-targets)

## 1.0 Introduction

```{r pressure, echo=FALSE, out.width = '75%', fig.align = 'center'}
#knitr::include_graphics("man/figures/README-unnamed-chunk-6-1.png")
```

Add Introduction!

[Back to top](#contents)

## 2.0 System setup and installation

*WhiteboxTools* and *whitebox* are required for ***IntegratedHydrology***. See
[whiteboxR](https://github.com/giswqs/whiteboxR) or below for
installation.

```{r, eval = FALSE}
## Follow instructions for whitebox installation accordingly
## devtools::install_github("giswqs/whiteboxR") # For development version
## whitebox is now available on CRAN
#install.packages("whitebox")

library(whitebox)

if (F){
  install_whitebox()
  # Possible warning message:
  # ------------------------------------------------------------------------
  # Could not find WhiteboxTools!
  # ------------------------------------------------------------------------
  #
  # Your next step is to download and install the WhiteboxTools binary:
  #     > whitebox::install_whitebox()
  #
  # If you have WhiteboxTools installed already run `wbt_init(exe_path=...)`':
  #    > wbt_init(exe_path='/home/user/path/to/whitebox_tools')
  #
  # For whitebox package documentation, ask for help:
  #    > ??whitebox
  #
  # For more information visit https://giswqs.github.io/whiteboxR/
  #
  # ------------------------------------------------------------------------
}

```

[Back to top](#contents)

## 3.0 Prepare DEM and Sampling Points for for analysis

### 3.1 Generate toy terrain dataset and sampling points

We begin by bringing in our toy digital elevation model and using it to
generate terrain products. Burning stream networks into the DEM is not yet
available within IntegratedHydrology, as there are several caveats associated with
this process. See [here](https://proceedings.esri.com/library/userconf/proc99/proceed/papers/pap802/p802.htm#Trois)


```{r, message = FALSE, error = FALSE, warning = FALSE}
## Load libraries
library(dplyr)
library(foreach)
library(future.apply)
library(hydroweight)
library(terra)
library(sf)
library(viridis)
library(whitebox)
library(IntegratedHydrology)
library(mapview)

## Generate save_dir as a temporary directory
save_dir <- tempdir()

## Import toy_dem from whitebox package
toy_file<-sample_dem_data()
toy_file <- system.file("extdata", "DEM.tif", package = "whitebox")
toy_dem <- rast(raster::raster(x = toy_file)) # reading the file from terra directly sometimes crashes R for some reason
crs(toy_dem) <- "epsg:3161"

## Write toy_dem to save_dir
writeRaster(
  x = toy_dem, filename = file.path(save_dir, "toy_dem.tif"),
  overwrite = TRUE
)

## Breach depressions to ensure continuous flow
wbt_breach_depressions(
  dem = file.path(save_dir, "toy_dem.tif"),
  output = file.path(save_dir, "toy_dem_breached.tif")
)

toy_dem<-rast(file.path(save_dir, "toy_dem_breached.tif"))

```

[Back to top](#contents)

### 3.2 Process DEM with `process_flowdir()`

```{r, fig.width = 7, fig.height = 7, message = FALSE, error = FALSE, warning = FALSE}

output_filename<-file.path(save_dir,"Processed_Hydrology.zip")

hydro_out<-process_flowdir(
  dem=toy_dem,
  threshold=1000L,  
  return_products=T,
  output_filename=output_filename,
  temp_dir=NULL, 
  verbose=T
)

hydro_out1<-generate_subbasins(
  input=hydro_out,
  return_products=T,
  temp_dir=NULL,
  verbose=F
) 

hydro_out2<-attrib_streamline( # fix mssing line segment here: hydro_out2$stream_lines
  input=hydro_out1,
  return_products=T,
  temp_dir=NULL,
  verbose=F
)

points<-rast(hydro_out$dem_streams_d8.tif) %>% 
  as.points() %>% 
  st_as_sf() %>% 
  filter(st_coordinates(.)[, 1] < 675000) %>% 
  rename(Sites=dem_streams_d8) %>% 
  .[c(10,12,50,100),] %>% 
  mutate(Sites=row_number()) %>% 
  st_jitter(5)

hydro_out25<-insert_points(
  input=hydro_out1,
  points=points,
  site_id_col="Sites",
  snap_distance=10,
  return_products=T,
  temp_dir=NULL,
  verbose=F
)

hydro_out3<-trace_flowpaths(
  input=hydro_out25,
  return_products=T,
  temp_dir=NULL,
  verbose=F
)

hydro_out4<-generate_pwisedist(
  input=hydro_out3,
  return_products=T,
  temp_dir=NULL,
  verbose=F
)

# hydro_out<-process_hydrology(
#   dem=toy_dem,
#   threshold=1000L,  
#   return_products=T,
#   save_dir=save_dir,
#   temp_dir=NULL, # location to store temporary files, may require significant space if processing a large DEM 
#   verbose=T
# )

mapview(hydro_out4$subbasins,zcol="link_id",legend=F)+
  mapview(hydro_out2$stream_lines)+
  mapview(hydro_out4$stream_lines,zcol="link_id",legend=F)+
  mapview(hydro_out4$links,zcol="link_id",legend=F)+
  mapview(hydro_out4$snapped_points,zcol="Sites",legend=F)

```

[Back to top](#contents)


[Back to top](#contents)

### 3.2 Process DEM with `process_flowdir()`

```{r, fig.width = 7, fig.height = 7, message = FALSE, error = FALSE, warning = FALSE}


```

[Back to top](#contents)
